import streamlit as st
import google.generativeai as genai
from PIL import Image
import json
import os

# --- ุฅุนุฏุงุฏ ุงูุตูุญุฉ ---
st.set_page_config(
    page_title="ูุงุณุญ ุงูุญูุงู ุงูุฐูู",
    page_icon="๐ฅ",
    layout="centered",
    initial_sidebar_state="expanded"
)

# --- ุงูุชูุณูู ุงูุฌูุงูู (CSS) ---
st.markdown("""
    <style>
    .stApp { direction: rtl; }
    .status-box { padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: bold; font-size: 24px; }
    .halal { background-color: #d1fae5; color: #065f46; border: 2px solid #34d399; }
    .haram { background-color: #fee2e2; color: #991b1b; border: 2px solid #f87171; }
    .doubtful { background-color: #fef3c7; color: #92400e; border: 2px solid #fbbf24; }
    </style>
""", unsafe_allow_html=True)

# --- ุงูุนููุงู ---
st.title("๐ฅ ูุงุณุญ ุงูุญูุงู ุงูุฐูู (AI)")
st.caption("ุงูุญุต ููููุงุช ุงูููุชุฌุงุช ุงูุบุฐุงุฆูุฉ ููุชุฃูุฏ ูู ุฎูููุง ูู ุงูููููุงุช ุงููุญุฑูุฉ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู.")

# --- ุงูุดุฑูุท ุงูุฌุงูุจู ---
with st.sidebar:
    st.header("โ๏ธ ุงูุฅุนุฏุงุฏุงุช")
    api_key = st.text_input("ููุชุงุญ Gemini API", type="password", help="ุฃุฏุฎู ููุชุงุญ API ุงูุฎุงุต ุจู ูู Google AI Studio")
    st.info("ููููู ุงูุญุตูู ุนูู ุงูููุชุงุญ ูุฌุงูุงู ูู: [Google AI Studio](https://aistudio.google.com/)")
    st.markdown("---")
    st.write("๐๏ธ ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ **Streamlit**")

# --- ุงูุชุญูู ูู ุงูููุชุงุญ ---
if not api_key:
    st.warning("โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ููุชุงุญ API ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ููุจุฏุก.")
    st.stop()

# ุฅุนุฏุงุฏ Gemini
genai.configure(api_key=api_key)

# --- ุฏุงูุฉ ุงูุชุญููู ---
def analyze_image(image_input):
    model = genai.GenerativeModel('gemini-1.5-flash')
    
    prompt = """
    ุฃูุช ุฎุจูุฑ ุฃุบุฐูุฉ ุฅุณูุงูู ูููุชุด ุญูุงู. ูู ุจุชุญููู ุงูุตูุฑุฉ ุฃู ุงููุต ุงููุฑูู ููุงุฆูุฉ ุงูููููุงุช.
    
    ุงูููุงุนุฏ:
    1. **ุญุฑุงู**: ุฎูุฒูุฑ (Pork)ุ ุฏูู (Lard)ุ ูุญูู (Alcohol)ุ ุฌููุงุชูู ุบูุฑ ูุญุฏุฏ ุงููุตุฏุฑุ ูุงุฑููู (E120)ุ ุดุญูุ ูุจูุฐ.
    2. **ูุดุชุจู ุจู (Doubtful)**: E471ุ ูุตู ุงููุจู (Whey)ุ ุงููุณุชุญูุจุงุชุ ุฅุฐุง ูู ูุฐูุฑ ุฃููุง ูุจุงุชูุฉ.
    3. **ุญูุงู**: ุฌููุน ุงูููููุงุช ุงููุจุงุชูุฉุ ุงููุงุกุ ุงูุณููุ ุงูุจูุถ.
    
    ุงููุทููุจ: ุฅุฑุฌุงุน ูุงุฆู JSON ููุท ุจุงูุตูุบุฉ ุงูุชุงููุฉ (ุจุฏูู ุฃู ูุตูุต ุฅุถุงููุฉ):
    {
        "status": "HALAL" ุฃู "HARAM" ุฃู "DOUBTFUL" ุฃู "NON_FOOD",
        "reason_ar": "ุดุฑุญ ูุตูุฑ ููุงุถุญ ุจุงูุนุฑุจูุฉ ููุณุจุจ",
        "ingredients": ["ูุงุฆูุฉ", "ุงูููููุงุช", "ุงูููุชุดูุฉ"]
    }
    """
    
    try:
        with st.spinner('ุฌุงุฑู ุชุญููู ุงูููููุงุช ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู... ๐ค'):
            response = model.generate_content([prompt, image_input])
            # ุชูุธูู ุงููุต ูุฅุฒุงูุฉ ุนูุงูุงุช ุงูู Markdown ุฅุฐุง ูุฌุฏุช
            clean_json = response.text.replace('```json', '').replace('```', '').strip()
            return json.loads(clean_json)
    except Exception as e:
        st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญููู: {str(e)}")
        return None

# --- ูุงุฌูุฉ ุงูุฅุฏุฎุงู ---
tabs = st.tabs(["๐ธ ุฑูุน ุตูุฑุฉ", "โ๏ธ ูุต ูุชุงุจู"])

# 1. ุชุจููุจ ุงูุตูุฑ
with tabs[0]:
    uploaded_file = st.file_uploader("ุงุฎุชุฑ ุตูุฑุฉ ูุงุถุญุฉ ููููููุงุช", type=['jpg', 'png', 'jpeg'])
    if uploaded_file:
        image = Image.open(uploaded_file)
        st.image(image, caption="ุงูุตูุฑุฉ ุงููุฑููุฉ", use_column_width=True)
        
        if st.button("ูุญุต ุงูุตูุฑุฉ", key="btn_img", type="primary"):
            result = analyze_image(image)
            if result:
                status = result.get('status')
                reason = result.get('reason_ar')
                
                if status == "HALAL":
                    st.markdown(f'<div class="status-box halal">โ ุญูุงู<br><small>{reason}</small></div>', unsafe_allow_html=True)
                elif status == "HARAM":
                    st.markdown(f'<div class="status-box haram">๐ซ ุญุฑุงู<br><small>{reason}</small></div>', unsafe_allow_html=True)
                elif status == "DOUBTFUL":
                    st.markdown(f'<div class="status-box doubtful">๐ค ูุดุชุจู ุจู<br><small>{reason}</small></div>', unsafe_allow_html=True)
                else:
                    st.info("ูู ูุชู ุงูุชุนุฑู ุนูู ุทุนุงู ุฃู ููููุงุช.")
                
                with st.expander("ูุงุฆูุฉ ุงูููููุงุช ุงูููุชุดูุฉ"):
                    st.write(result.get('ingredients'))

# 2. ุชุจููุจ ุงููุต
with tabs[1]:
    text_input = st.text_area("ุงูุชุจ ุฃู ุงูุตู ุงูููููุงุช ููุง", height=150, placeholder="ูุซุงู: ูุงุกุ ุณูุฑุ ุฌููุงุชููุ ูููุฉ ุตูุงุนูุฉ...")
    if st.button("ูุญุต ุงููุต", key="btn_txt", type="primary"):
        if text_input:
            result = analyze_image(text_input)
            if result:
                status = result.get('status')
                reason = result.get('reason_ar')
                
                if status == "HALAL":
                    st.success(f"โ **ุญูุงู**: {reason}")
                elif status == "HARAM":
                    st.error(f"๐ซ **ุญุฑุงู**: {reason}")
                elif status == "DOUBTFUL":
                    st.warning(f"๐ค **ูุดุชุจู ุจู**: {reason}")
                else:
                    st.info("ุงููุต ูุง ูุจุฏู ูููููุงุช ุบุฐุงุฆูุฉ.")
        else:
            st.warning("ูุฑุฌู ูุชุงุจุฉ ูุต ุงูููููุงุช ุฃููุงู.")

# --- ุชุฐููู ---
st.markdown("---")
st.caption("โ๏ธ ููุงุญุธุฉ: ุงููุชุงุฆุฌ ุชุนุชูุฏ ุนูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุฏ ุชุญุชูู ุงูุฎุทุฃ. ูุฑุฌู ุงูุชุญูู ุฏุงุฆูุงู ูู ุงูููุชุฌ ุจููุณู.")